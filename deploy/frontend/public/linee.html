<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <title>Gestione Linee di Trasporto</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/assets/css/main.css" />
    <style>
        table { border-collapse: collapse; width: 100%; table-layout: fixed; margin: 20px auto; }
        th, td { border: 1px solid #aaa; padding: 1px; text-align: center; }
        input[type="text"], input[type="number"] { width: 100%; }
        button { padding: 5px 10px; margin: 2px; }
        #aggiungiForm { margin: 20px auto; width: 80%; }
        #aggiungiForm input, #aggiungiForm select {
            display: inline-block;
            vertical-align: middle;
            height: 30px;
            font-size: 14px;
            padding: 5px;
            margin-right: 10px;
        }
        #messagesArea {
            width: 80%;
            margin: 20px auto 0 auto;
        }
        .perm-message {
            position: relative;
            margin-bottom: 10px;
            padding: 16px 40px 16px 16px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            border: 1px solid #c3e6cb;
            background: #d4edda;
            color: #155724;
            animation: fadein 0.2s;
        }
        .perm-message.error {
            border: 1px solid #f5c6cb;
            background: #f8d7da;
            color: #721c24;
        }
        .perm-message .close-btn {
            position: absolute;
            right: 12px;
            top: 8px;
            font-size: 18px;
            color: inherit;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        @keyframes fadein {
            from { opacity: 0; }
            to   { opacity: 1; }
        }

        input[type="text"], input[type="number"], select {
            width: calc(100% - 20px);
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* Fix per input nella tabella */
        #tabellaLineeBus input[type="number"],
        #tabellaLineeBus input[type="text"] {
            width: 100%;
            box-sizing: border-box;
            padding: 4px;
            margin: 0;
            font-size: 15px;
        }

        button {
            transition-duration: 0.4s;
            border: none;
            font-size: 16px;
            border-radius: 4px;
        }

        button:hover {
            background-color: #04AA6D; /* Green */
            color: white;
        }

        /* Centra il bottone in fondo */
        .center-btn {
            display: flex;
            justify-content: center;
            margin: 2em 0 2em 0;
        }
    </style>
</head>
<body class="is-preload">

    <!-- Header -->
    <header id="header" style="width:20%;">
        <div class="inner">
            <a href="map.html" class="image dozza"><img src="/images/thumbs/dozza.jpg" width="100%" alt="" /></a>
            <h1 style="font-size: 30px"><strong>Dozza Turism</strong></h1>
            <p style="font-size:15px;">Applicazione gestita dall'amministrazione pubblica del Comune di Dozza, orientata all'ottimizzazione e gestione dei flussi turistici. </p>
        </div>
    </header>

    <!-- Main -->
    <div id="main" style="margin-left: 20%; max-width: 160em; width: calc(100% - 20%);">

        <!-- One -->
        <section class="intro">
            <header>
                <h2>Gestione Linee di Trasporto</h2>
                <p>Aggiungi Linea</p>
            </header>
            <div class="content">
                <div id="aggiungiForm" style="width: 80%; margin: 20px auto; border: 1px solid #ccc; padding: 15px; border-radius: 10px; background: #f9f9f9;text-align: center;">
                    <input type="text" id="nome" placeholder="Nome linea" />
                    <input type="text" id="comune_partenza" placeholder="Comune partenza" />
                    <input type="text" id="partenza_lat" placeholder="Latitudine partenza" />
                    <input type="text" id="partenza_lng" placeholder="Longitudine partenza" />
                    <input type="text" id="comune_arrivo" placeholder="Comune arrivo" />
                    <input type="text" id="arrivo_lat" placeholder="Latitudine arrivo" />
                    <input type="text" id="arrivo_lng" placeholder="Longitudine arrivo" />
                    <input type="number" id="capienza" placeholder="Capienza" min="0" />
                    <input type="number" id="frequenza_giornaliera" placeholder="Frequenza Giornaliera" min="0" step="any" />
                    <select id="attiva">
                        <option value="true">Attiva</option>
                        <option value="false">Non attiva</option>
                    </select>
                    <select id="sabato">
                        <option value="true">Sabato attiva</option>
                        <option value="false">Sabato non attiva</option>
                    </select>
                    <select id="domenica">
                        <option value="true">Domenica attiva</option>
                        <option value="false">Domenica non attiva</option>
                    </select>
                    <a href="#" style="margin-top: 10px; align-items: center;" class="button" onclick="aggiungiLinea(); return false;">Inserisci</a>

                    <!-- Area messaggi permanenti -->
                    <div id="messagesArea"></div>
                </div>
            </div>
        </section>

        <!-- Two -->
        <section id="two">

            <div id="dettagliLinea" style="display:none; width:120%; margin: 20px auto; border: 1px solid #ccc; padding: 8em 1em 4em 1em; border-radius: 10px; background: #f9f9f9;">
                <h3>Dettagli Linea</h3>
                <p><strong>Nome:</strong> <span id="dettNomeLinea"></span></p>
                <p><strong>Comune partenza:</strong> <span id="dettPartenza"></span></p>
                <p><strong>Latitudine partenza:</strong> <span id="dettPartenzaLat"></span></p>
                <p><strong>Longitudine partenza:</strong> <span id="dettPartenzaLng"></span></p>
                <p><strong>Comune arrivo:</strong> <span id="dettArrivo"></span></p>
                <p><strong>Latitudine arrivo:</strong> <span id="dettArrivoLat"></span></p>
                <p><strong>Longitudine arrivo:</strong> <span id="dettArrivoLng"></span></p>
                <p><strong>Capienza:</strong> <span id="dettCapienza"></span></p>
                <p><strong>Attiva:</strong> <span id="dettAttiva"></span></p>
                <p><strong>Sabato:</strong> <span id="dettSabato"></span></p>
                <p><strong>Domenica:</strong> <span id="dettDomenica"></span></p>
                <p><strong>Frequenza giornaliera:</strong> <span id="dettFrequenza"></span></p>
                <button onclick="nascondiDettagli()">Chiudi</button>
            </div>

            <table id="tabellaLineeBus">
                <thead>
                    <tr>
                        <th style="width: 80px">Nome linea</th>
                        <th style="width: 115px">Comune partenza</th>
                        <th style="width: 110px">Comune arrivo</th>
                        <th style="width: 90px;">Capienza</th>
                        <th style="width: 115px">Attiva</th>
                        <th style="width: 115px">Sabato</th>
                        <th style="width: 115px">Domenica</th>
                        <th style="width: 90px;">Frequenza giornaliera</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <!-- Bottone Torna alla mappa centrato in fondo -->
        <div class="center-btn">
            <a href="#" class="button" onclick="window.history.back(); return false;">Torna alla mappa</a>
        </div>
    </div>
    <!-- JS CORE -->
    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/jquery.scrolly.min.js"></script>
    <script src="/assets/js/browser.min.js"></script>
    <script src="/assets/js/breakpoints.min.js"></script>
    <script src="/assets/js/util.js"></script>
    <script src="/assets/js/main.js"></script>

    <!-- JS LOGIC -->
    <script>
        const baseURL = '/api/linee';

        // Mostra un messaggio permanente sopra la tabella
        function showPermMessage(message, type='success') {
            const area = document.getElementById('messagesArea');
            const msg = document.createElement('div');
            msg.className = 'perm-message' + (type === 'error' ? ' error' : '');
            msg.innerHTML = `<button class="close-btn" onclick="this.parentNode.remove()">×</button>${message}`;
            area.appendChild(msg);
        }

        // Modale di conferma personalizzata
        function customConfirm(message) {
            return new Promise((resolve) => {
                // Overlay
                const overlay = document.createElement('div');
                overlay.style.position = 'fixed';
                overlay.style.top = 0;
                overlay.style.left = 0;
                overlay.style.width = '100vw';
                overlay.style.height = '100vh';
                overlay.style.background = 'rgba(0,0,0,0.3)';
                overlay.style.display = 'flex';
                overlay.style.alignItems = 'center';
                overlay.style.justifyContent = 'center';
                overlay.style.zIndex = 9999;

                // Box
                const box = document.createElement('div');
                box.style.background = '#fff';
                box.style.padding = '24px 32px';
                box.style.borderRadius = '10px';
                box.style.boxShadow = '0 2px 12px rgba(0,0,0,0.2)';
                box.style.textAlign = 'center';
                box.innerHTML = `<div style="margin-bottom:18px;font-size:18px;">${message}</div>`;

                // Bottoni
                const btnYes = document.createElement('button');
                btnYes.textContent = 'Sì';
                btnYes.style.margin = '0 10px';
                btnYes.onclick = () => { document.body.removeChild(overlay); resolve(true); };

                const btnNo = document.createElement('button');
                btnNo.textContent = 'No';
                btnNo.style.margin = '0 10px';
                btnNo.onclick = () => { document.body.removeChild(overlay); resolve(false); };

                box.appendChild(btnYes);
                box.appendChild(btnNo);
                overlay.appendChild(box);
                document.body.appendChild(overlay);
            });
        }

        // Carica e mostra le linee
        async function caricaLinee() {
            const res = await fetch(baseURL);
            const data = await res.json();
            const tbody = document.querySelector('#tabellaLineeBus tbody');
            tbody.innerHTML = '';

            data.forEach(l => {
                const tr = document.createElement('tr');

                // Nome linea
                const nomeTd = document.createElement('td');
                const nomeInput = document.createElement('input');
                nomeInput.type = 'text';
                nomeInput.value = l.nome || '';
                nomeTd.appendChild(nomeInput);
                tr.appendChild(nomeTd);

                // Comune partenza
                const partenzaComuneTd = document.createElement('td');
                const partenzaComuneInput = document.createElement('input');
                partenzaComuneInput.type = 'text';
                partenzaComuneInput.value = l.comune_partenza || '';
                partenzaComuneTd.appendChild(partenzaComuneInput);
                tr.appendChild(partenzaComuneTd);

                // Comune arrivo
                const arrivoComuneTd = document.createElement('td');
                const arrivoComuneInput = document.createElement('input');
                arrivoComuneInput.type = 'text';
                arrivoComuneInput.value = l.comune_arrivo || '';
                arrivoComuneTd.appendChild(arrivoComuneInput);
                tr.appendChild(arrivoComuneTd);

                // Capienza
                const capienzaTd = document.createElement('td');
                const capienzaInput = document.createElement('input');
                capienzaInput.type = 'number';
                capienzaInput.min = 0;
                capienzaInput.value = l.capienza || 0;
                capienzaTd.appendChild(capienzaInput);
                tr.appendChild(capienzaTd);

                // Attiva
                const attivaTd = document.createElement('td');
                const attivaSelect = document.createElement('select');
                ['true','false'].forEach(val => {
                    const opt = document.createElement('option');
                    opt.value = val;
                    opt.textContent = val === 'true' ? 'Attiva' : 'Non attiva';
                    attivaSelect.appendChild(opt);
                });
                attivaSelect.value = l.attiva ? 'true' : 'false';
                attivaTd.appendChild(attivaSelect);
                tr.appendChild(attivaTd);

                // Sabato
                const sabatoTd = document.createElement('td');
                const sabatoSelect = document.createElement('select');
                ['true','false'].forEach(val => {
                    const opt = document.createElement('option');
                    opt.value = val;
                    opt.textContent = val === 'true' ? 'attiva' : 'Non attiva';
                    sabatoSelect.appendChild(opt);
                });
                sabatoSelect.value = l.sabato ? 'true' : 'false';
                sabatoTd.appendChild(sabatoSelect);
                tr.appendChild(sabatoTd);

                // Domenica
                const domenicaTd = document.createElement('td');
                const domenicaSelect = document.createElement('select');
                ['true','false'].forEach(val => {
                    const opt = document.createElement('option');
                    opt.value = val;
                    opt.textContent = val === 'true' ? 'attiva' : 'Non attiva';
                    domenicaSelect.appendChild(opt);
                });
                domenicaSelect.value = l.domenica ? 'true' : 'false';
                domenicaTd.appendChild(domenicaSelect);
                tr.appendChild(domenicaTd);

                // Frequenza giornaliera
                const freqTd = document.createElement('td');
                const freqInput = document.createElement('input');
                freqInput.type = 'number';
                freqInput.min = 0;
                freqInput.step = 'any';
                freqInput.value = (typeof l.frequenza_giornaliera === 'string'
                    ? l.frequenza_giornaliera.replace(',', '.')
                    : l.frequenza_giornaliera) || 0;
                freqTd.appendChild(freqInput);
                tr.appendChild(freqTd);

                // Azioni
                const azioniTd = document.createElement('td');
                // Dettagli
                const btnDettagli = document.createElement('button');
                btnDettagli.textContent = 'Dettagli';
                btnDettagli.onclick = () => mostraDettagli(l.id, tr);
                azioniTd.appendChild(btnDettagli);
                // Salva
                const btnSalva = document.createElement('button');
                btnSalva.textContent = 'Salva';
                btnSalva.onclick = async () => {
                    await salvaLinea(l.id, {
                        nome: nomeInput.value,
                        comune_partenza: partenzaComuneInput.value,
                        partenza_lat: l.partenza_lat,
                        partenza_lng: l.partenza_lng,
                        comune_arrivo: arrivoComuneInput.value,
                        arrivo_lat: l.arrivo_lat,
                        arrivo_lng: l.arrivo_lng,
                        capienza: parseInt(capienzaInput.value),
                        attiva: attivaSelect.value === 'true',
                        sabato: sabatoSelect.value === 'true',
                        domenica: domenicaSelect.value === 'true',
                        frequenza_giornaliera: parseFloat(freqInput.value.replace(',', '.'))
                    });
                    showPermMessage('Linea aggiornata!');
                };
                azioniTd.appendChild(btnSalva);
                // Elimina
                const btnElimina = document.createElement('button');
                btnElimina.textContent = 'Elimina';
                btnElimina.onclick = async () => {
                    const conferma = await customConfirm(`Sei sicuro di voler eliminare la linea "${l.nome}"?`);
                    if (conferma) {
                        await eliminaLinea(l.id);
                        showPermMessage('Linea eliminata!', 'error');
                    }
                };
                azioniTd.appendChild(btnElimina);

                tr.appendChild(azioniTd);
                tbody.appendChild(tr);
            });
        }

        // Dettagli linea
        async function mostraDettagli(id, tr) {
            try {
                const res = await fetch(`/api/linee/${id}`);
                if (!res.ok) {
                    showPermMessage('Linea non trovata', 'error');
                    return;
                }
                const data = await res.json();
                document.getElementById('dettNomeLinea').textContent = data.nome;
                document.getElementById('dettPartenza').textContent = data.comune_partenza;
                document.getElementById('dettPartenzaLat').textContent = data.partenza_lat;
                document.getElementById('dettPartenzaLng').textContent = data.partenza_lng;
                document.getElementById('dettArrivo').textContent = data.comune_arrivo;
                document.getElementById('dettArrivoLat').textContent = data.arrivo_lat;
                document.getElementById('dettArrivoLng').textContent = data.arrivo_lng;
                document.getElementById('dettCapienza').textContent = data.capienza;
                document.getElementById('dettAttiva').textContent = data.attiva;
                document.getElementById('dettSabato').textContent = data.sabato;
                document.getElementById('dettDomenica').textContent = data.domenica;
                document.getElementById('dettFrequenza').textContent = data.frequenza_giornaliera;
                document.getElementById('dettagliLinea').style.display = 'block';
                showPermMessage('Dettagli visualizzati');
            } catch (e) {
                showPermMessage('Errore: ' + e.message, 'error');
            }
        }
        function nascondiDettagli() {
            document.getElementById('dettagliLinea').style.display = 'none';
        }

        // Salva linea (PUT)
        async function salvaLinea(id, dati) {
            try {
                const res = await fetch(`${baseURL}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dati)
                });
                if (!res.ok) {
                    showPermMessage('Errore aggiornamento', 'error');
                } else {
                    caricaLinee();
                }
            } catch (e) {
                showPermMessage('Errore: ' + e.message, 'error');
            }
        }

        // Elimina linea (DELETE)
        async function eliminaLinea(id) {
            try {
                const res = await fetch(`${baseURL}/${id}`, { method: 'DELETE' });
                if (!res.ok) {
                    showPermMessage('Errore eliminazione', 'error');
                } else {
                    caricaLinee();
                }
            } catch (e) {
                showPermMessage('Errore: ' + e.message, 'error');
            }
        }

        // Aggiungi linea (POST)
        async function aggiungiLinea() {
            const nome = document.getElementById('nome').value.trim();
            const comune_partenza = document.getElementById('comune_partenza').value.trim();
            const partenza_lat = document.getElementById('partenza_lat').value.trim();
            const partenza_lng = document.getElementById('partenza_lng').value.trim();
            const comune_arrivo = document.getElementById('comune_arrivo').value.trim();
            const arrivo_lat = document.getElementById('arrivo_lat').value.trim();
            const arrivo_lng = document.getElementById('arrivo_lng').value.trim();
            const capienza = parseInt(document.getElementById('capienza').value);
            const attiva = document.getElementById('attiva').value === 'true';
            const sabato = document.getElementById('sabato').value === 'true';
            const domenica = document.getElementById('domenica').value === 'true';
            const frequenza_giornaliera = parseFloat(document.getElementById('frequenza_giornaliera').value.replace(',', '.'));

            if (!nome || !comune_partenza || !partenza_lat || !partenza_lng ||
                !comune_arrivo || !arrivo_lat || !arrivo_lng ||
                isNaN(capienza) || isNaN(frequenza_giornaliera)) {
                showPermMessage('Inserisci tutti i dati correttamente', 'error');
                return;
            }

            try {
                const res = await fetch(baseURL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nome,
                        comune_partenza,
                        partenza_lat,
                        partenza_lng,
                        comune_arrivo,
                        arrivo_lat,
                        arrivo_lng,
                        capienza,
                        attiva,
                        sabato,
                        domenica,
                        frequenza_giornaliera
                    })
                });
                if (res.ok) {
                    await caricaLinee();
                    showPermMessage('Linea aggiunta!');
                    // Reset form
                    document.getElementById('nome').value = '';
                    document.getElementById('comune_partenza').value = '';
                    document.getElementById('partenza_lat').value = '';
                    document.getElementById('partenza_lng').value = '';
                    document.getElementById('comune_arrivo').value = '';
                    document.getElementById('arrivo_lat').value = '';
                    document.getElementById('arrivo_lng').value = '';
                    document.getElementById('capienza').value = '';
                    document.getElementById('attiva').value = 'true';
                    document.getElementById('sabato').value = 'true';
                    document.getElementById('domenica').value = 'true';
                    document.getElementById('frequenza_giornaliera').value = '';
                } else {
                    showPermMessage('Errore aggiunta', 'error');
                }
            } catch (e) {
                showPermMessage('Errore: ' + e.message, 'error');
            }
        }

        // Carica dati all'avvio
        caricaLinee();
    </script>
</body>
</html>